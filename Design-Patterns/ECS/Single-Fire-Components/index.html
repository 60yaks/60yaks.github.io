<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no"><!--Description--><meta name="description" content="60 Yaks Per Second"><!--Author--><meta name="author" content="60 Yaks"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="manifest" href="/site.webmanifest"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><meta name="msapplication-TileColor" content="#da532c"><meta name="theme-color" content="#ffffff"><!-- Title --><title>Single Fire Components - 60 Yaks</title><!-- Bootstrap core CSS --><link href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous"><!-- Custom fonts for this template --><link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous"><link href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" rel="stylesheet" type="text/css"><link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css"><!-- Custom styles for this template --><link href="/css/theme.css" rel="stylesheet"><link rel="stylesheet" href="/css/prism-xonokai.css" type="text/css"></head><body><!-- Navigation --><nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav"><div class="container"><a class="navbar-brand" href="/">60 Yaks per Second</a> <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">Menu <i class="fa fa-bars"></i></button><div class="collapse navbar-collapse" id="navbarResponsive"><ul class="navbar-nav ml-auto"><li class="nav-item"><a class="nav-link" href="/">Home</a></li><li class="nav-item"><a class="nav-link" href="/tags">Tags</a></li><li class="nav-item"><a class="nav-link" href="/categories">Categories</a></li></ul></div></div></nav><!-- Page Header --><header class="masthead" style="background-image:linear-gradient(rgba(0,0,0,.6),rgba(0,0,0,.6)),url(https://source.unsplash.com/zMVt3FgSMd4/undefined)"><div class="container"><div class="row"><div class="col-lg-8 col-md-10 mx-auto"><div class="post-heading"><h1>Single Fire Components</h1><span class="meta">3rd June 2018 in <span id="categories"><span><a href="/categories/Design-Patterns/">Design Patterns</a></span> <span><a href="/categories/Design-Patterns/ECS/">ECS</a></span></span> <span class="index-tags"><a href="/tags/Design-Patterns/" class="badge badge-primary">#Design Patterns</a> <a href="/tags/ECS/" class="badge badge-primary">#ECS</a></span></span></div></div><div class="col-lg-12 col-md-12"><div class="unsplash-credit float-right"><h6>Photo by <a target="_blank" href="https://unsplash.com/photos/zMVt3FgSMd4">rawpixel</a></h6></div></div></div></div></header><article><div class="container"><div class="row"><div class="col-lg-8 col-md-10 mx-auto"><p>Since using Entity Component System architecture for game design I’ve noticed a number of common patterns that are useful for solving different types of problems the “ECS” way. In this article I want to talk about what I’m calling the Single Fire Component pattern.</p><a id="more"></a><p>Here’s a scenario. Your character is walking around the screen and they enter a trigger. In an ECS world how do you deal with this?</p><p>The answer is to provide a mechanism so that when the entity (the character) enters the trigger, a single use component is added to that entity. Then a system that is watching for that component fires, and at the end of that update that system (or a dedicated cleanup system) takes that component off the entity.</p><p>Components don’t always need to contain data. Sometimes they can just act as flags for a system to either respond to, or ignore, a given entity. In this case we want to use the component as a positive flag so the system knows when to act on an entity.</p><div class="unsplash"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://source.unsplash.com/8kDOOrs608I/800x200" alt="Photo by Paul Gilmore" width="800" height="200"><div class="unsplash-credit"><a href="https://unsplash.com/photos/8kDOOrs608I" target="_blank" rel="noopener">Photo by Paul Gilmore</a></div></div><h3 id="Teleport-System"><a href="#Teleport-System" class="headerlink" title="Teleport System"></a>Teleport System</h3><p>Let’s go through an example. In the game I’m working on I needed a way to teleport things once they entered a trigger. The teleport is triggered from a collision, and moves the position of the entity to a fixed point.</p><h5 id="Adding-the-component"><a href="#Adding-the-component" class="headerlink" title="Adding the component"></a>Adding the component</h5><p>First, I need a way to add the <code>component</code> to the <code>entity</code> on a trigger. This is done with a <code>MonoBehaviour</code> as right now there’s no pure ECS way to use physics or colliders.</p><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>Serializable<span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">struct</span> Transition <span class="token punctuation">:</span> IComponentData
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> float2 Location<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token punctuation">[</span><span class="token function">RequireComponent</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>Collider2D<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AddTransitionComponentOnTrigger</span> <span class="token punctuation">:</span> MonoBehaviour
<span class="token punctuation">{</span>
    <span class="token comment" spellcheck="true">// The location to set the transform too.</span>
    <span class="token punctuation">[</span>SerializeField<span class="token punctuation">]</span> <span class="token keyword">private</span> Transform location<span class="token punctuation">;</span>

    <span class="token keyword">void</span> <span class="token function">OnTriggerEnter2D</span><span class="token punctuation">(</span>Collider2D collider<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">// Get the entity part of the object that collided with the trigger.</span>
        <span class="token keyword">var</span> entityComponent <span class="token operator">=</span> collider<span class="token punctuation">.</span>gameObject<span class="token punctuation">.</span><span class="token generic-method function">GetComponent<span class="token punctuation">&lt;</span>GameObjectEntity<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment" spellcheck="true">// Add the component to the entity.</span>
        entityComponent<span class="token punctuation">.</span>EntityManager<span class="token punctuation">.</span><span class="token function">AddComponentData</span><span class="token punctuation">(</span>entityComponent<span class="token punctuation">.</span>Entity<span class="token punctuation">,</span>
            <span class="token keyword">new</span> <span class="token class-name">Transition</span> <span class="token punctuation">{</span>
              Location <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">float2</span><span class="token punctuation">(</span>location<span class="token punctuation">.</span>position<span class="token punctuation">.</span>x<span class="token punctuation">,</span> location<span class="token punctuation">.</span>position<span class="token punctuation">.</span>y<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h5 id="Using-the-component"><a href="#Using-the-component" class="headerlink" title="Using the component"></a>Using the component</h5><p>Now that the <code>entity</code> has a <code>component</code> added to it, a <code>system</code> can take over and perform some task. In our case we want the <code>system</code> to update the <code>entities</code> position based on the data in the <code>Transition component</code>.</p><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token function">UpdateAfter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>MoveForward2DSystem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransitionSystem</span> <span class="token punctuation">:</span> JobComponentSystem
<span class="token punctuation">{</span>
<span class="token punctuation">}</span>
</code></pre><p>First, we want the system to copy the <code>Transition</code> data from the component to the <code>Position2D</code> of the entity.</p><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span>ComputeJobOptimization<span class="token punctuation">]</span>
<span class="token keyword">struct</span> CopyTransition <span class="token punctuation">:</span> IJobProcessComponentData<span class="token operator">&lt;</span>Transition<span class="token punctuation">,</span> Position2D<span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Execute</span><span class="token punctuation">(</span>
        <span class="token punctuation">[</span>ReadOnly<span class="token punctuation">]</span><span class="token keyword">ref</span> Transition transition<span class="token punctuation">,</span> 
        <span class="token keyword">ref</span> Position2D position<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> 
        position <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Position2D</span> <span class="token punctuation">{</span> Value <span class="token operator">=</span> transition<span class="token punctuation">.</span>Location <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><p>Then, we want to remove the <code>Transition</code> component from the entity.</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">struct</span> RemoveTransition <span class="token punctuation">:</span> IJob
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span>ReadOnly<span class="token punctuation">]</span> <span class="token keyword">public</span> EntityArray entities<span class="token punctuation">;</span>
    <span class="token keyword">public</span> EntityCommandBuffer entityCommandBuffer<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> entities<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
            entityCommandBuffer<span class="token punctuation">.</span><span class="token generic-method function">RemoveComponent<span class="token punctuation">&lt;</span>Transition<span class="token punctuation">></span></span><span class="token punctuation">(</span>entities<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Why do we need to use a command buffer to remove the component? When you’re in a job, you can’t access the entity manager, so you cannot remove a component using that. A job must use an <code>EntityCommandBuffer</code> to remove the component instead.</p><p>And now we schedule those jobs in the <code>TransitionSystem</code>.</p><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token function">UpdateAfter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>MoveForward2DSystem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransitionSystem</span> <span class="token punctuation">:</span> JobComponentSystem
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span>ComputeJobOptimization<span class="token punctuation">]</span>
    <span class="token keyword">struct</span> CopyTransition <span class="token punctuation">:</span> IJobProcessComponentData<span class="token operator">&lt;</span>Transition<span class="token punctuation">,</span> Position2D<span class="token operator">></span> <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>
    <span class="token keyword">struct</span> RemoveTransition <span class="token punctuation">:</span> IJob <span class="token punctuation">{</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">}</span>

    EndFrameBarrier endFrameBarrier<span class="token punctuation">;</span>
    ComponentGroup componentGroup<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnCreateManager</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        endFrameBarrier <span class="token operator">=</span> World<span class="token punctuation">.</span><span class="token generic-method function">GetOrCreateManager<span class="token punctuation">&lt;</span>EndFrameBarrier<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        componentGroup <span class="token operator">=</span> <span class="token function">GetComponentGroup</span><span class="token punctuation">(</span>
            ComponentType<span class="token punctuation">.</span><span class="token function">ReadOnly</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>Transition<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
            <span class="token keyword">typeof</span><span class="token punctuation">(</span>Position2D<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> JobHandle <span class="token function">OnUpdate</span><span class="token punctuation">(</span>JobHandle inputDeps<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> entities <span class="token operator">=</span> componentGroup<span class="token punctuation">.</span><span class="token function">GetEntityArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> copyTransitionJob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> copyTransitionJobHandle <span class="token operator">=</span> copyTransitionJob<span class="token punctuation">.</span><span class="token function">Schedule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> removeComponentsJob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RemoveTransition</span>
        <span class="token punctuation">{</span>
            entities <span class="token operator">=</span> entities<span class="token punctuation">,</span>
            entityCommandBuffer <span class="token operator">=</span> endFrameBarrier<span class="token punctuation">.</span><span class="token function">CreateCommandBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> removeComponentsJobHandle <span class="token operator">=</span> 
            removeComponentsJob<span class="token punctuation">.</span><span class="token function">Schedule</span><span class="token punctuation">(</span>copyTransitionJobHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> removeComponentsJobHandle<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>Notice how the <code>CopyTransition</code> job is chained to the <code>RemoveTransition</code> job so they run in that order.</p><div class="unsplash"><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAAEsCAMAAABOo35HAAAABGdBTUEAAK/INwWK6QAAABl0RVh0U29mdHdhcmUAQWRvYmUgSW1hZ2VSZWFkeXHJZTwAAAC9UExURVlZWdPT07KysmRkZIWFhfT09JmZmWZmZm9vb39/fxkZGUxMTDMzM3p6epCQkKamppubm729venp6cjIyN7e3tbW1s/Pz8LCwnx8fLS0tFZWVoiIiI+Pj6GhoeTk5Glpabu7u93d3evr66CgoJSUlKqqqsnJyeDg4Hd3d8PDw+Xl5bi4uNHR0dvb26Ojo6urq+fn51hYWDg4OCgoKHBwcK2traenp0FBQe7u7vHx8U5OTre3t8zMzHV1df///7GrnpQAAAA/dFJOU///////////////////////////////////////////////////////////////////////////////////AI4mfBcAAAUGSURBVHja7NoJb6M4GMZxY0NCD64kve/pMZ2d3Z297+X7f6zFNmBAMUXa6URl/q9UJSWPUPzrizFWRUlNLgEBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYYIEFAVhggQUWWGBBABZYYIEFFlgQgAUWWGCBBRYEYIEFFlhggQUBWGCBBRZYYEEAFlhggQUWWBCABRZYYIEFFgRggQUWWGCBBQFYYIEFFlhgQQAWWGCBBRZYEIAFFlhggQUWBGCBBRZYn6cCIcRXgvX/h9qcIVBqDdbEM8RCxGCB9QqXYRwHYDHBgwXWl8eKZKiESHI3Ba1kWs3fKixcaJUl1YyeBm7Ocq+yLItUiVBGnXxenSHJolIKEcwHq6ikbOX1YGVzQCTN8LPmSLreghUl9sN4Uw7yajMrLC0TZ1ImzqY6FEop0+pIaEN5HaoOxVuwEqFyc4I46uSlzOLqgxlh6UaR9l3VYWl9Fdoxb1Q90KJtu41pwwFW/WHhTtW8i7TafLCqRsk6bsGw63L9qurXRmuIlbT9lDQnlXU+nBFW1Q2qnZbDprWa2tjR90LZFqx1/+Td/HpGWLlrLDvIwTcx6dQ1Vrntbig68cDms3JwbA5Y1azs1ger6sNV/bbIw1jU81MvNAGrl58RVn8ozW+btF08iGFoAlYvP3csfVur1gJBEIA1uBmue5dhZDOyO2epbmgCVi8/I6x0MMHH9pjsTfBhNzQBq5uPZoQlB0uH3DZG4EZqQ26fL3sZq5uf09Ih6qw3i/pm6BZO0qZX7rrUS68Xsbr5ZE4rePMk08pk9aUZugfqppvs6AM1Acvlo/StP+6EbW06z8hJqxbYp2BZPQUnFsLsKuhQdaHqn5ewbF7KXIn0jWO5MqOQ7RaNLPtbNMmmhimj0GUmYLl8Gs0Lq4wyPbTu1l2QKqHSouzs3OlDIslW5SQsnY/NXmFplyNvEuuLV/Tau9BzwiraDUSwXmysztYWWNtL1psXeumgIrDGaqXvBfUuvtqUYI3V2t1wk1e2msFluJJm6zDJXv/fIfjPP7DAAgsssCiwwAILLLDAosACCyywwAKLAgsssMACC6zt9fDz/v75tyOB+98PD2+ORgKffjw4OP1uJPDxl+Xy8v1I4MPF3t7VNyOB4/vF4uzdzrG+39f1kz/w66Guv/yBvw90KX/gZKkr8Qf+2dOV+gNHC12/7RxrabD2/a31bLAO/a11YbAO/K21MFhLf2s9Gqw9f2vdGqzFu11jnVusE2/gxmI9eQOnFuvYG7i0WH7uK4t15w2cWazrXWP9a7H8f/bQYvm/6IPF+sF/pVssf19Ii/WH/0K2WH/uGuvEWC39gSdj9Twy+Rqri5EZx1gt/IE7Y/XoD1wbq9vd3w1PlufnD2OBp+ebm/uxwPHF6emnscDR4vLy41jg7vHq6sNY4Pr27OyYdRaLUrDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssMCiwAILLLDAAosCCyywwAILLAossMACCyywKLDAAgsssL6u+k+AAQCR9eHtLKvLfwAAAABJRU5ErkJggg==" data-original="https://source.unsplash.com/nwzBOsmrhy4/800x200" alt="Photo by nibras al-riyami" width="800" height="200"><div class="unsplash-credit"><a href="https://unsplash.com/photos/nwzBOsmrhy4" target="_blank" rel="noopener">Photo by nibras al-riyami</a></div></div><h3 id="Extracting-the-pattern"><a href="#Extracting-the-pattern" class="headerlink" title="Extracting the pattern"></a>Extracting the pattern</h3><p>This single-fire idea seems useful. So let’s take our system and make it reusable.</p><pre class="language-csharp"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SingleFireSystem</span><span class="token operator">&lt;</span>TComponent<span class="token punctuation">,</span> TBarrier<span class="token operator">></span> <span class="token punctuation">:</span> JobComponentSystem
    <span class="token keyword">where</span> TComponent <span class="token punctuation">:</span> IComponentData
    <span class="token keyword">where</span> TBarrier <span class="token punctuation">:</span> BarrierSystem
<span class="token punctuation">{</span>
    <span class="token keyword">struct</span> RemoveComponentJob <span class="token punctuation">:</span> IJob
    <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>ReadOnly<span class="token punctuation">]</span> <span class="token keyword">public</span> EntityArray entities<span class="token punctuation">;</span>
        <span class="token keyword">public</span> EntityCommandBuffer entityCommandBuffer<span class="token punctuation">;</span>

        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> entities<span class="token punctuation">.</span>Length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span>
                entityCommandBuffer<span class="token punctuation">.</span><span class="token generic-method function">RemoveComponent<span class="token punctuation">&lt;</span>TComponent<span class="token punctuation">></span></span><span class="token punctuation">(</span>entities<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> ComponentGroup <span class="token keyword">group</span><span class="token punctuation">;</span>
    <span class="token keyword">protected</span> BarrierSystem barrier<span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token keyword">abstract</span> JobHandle <span class="token function">CreateJobHandle</span><span class="token punctuation">(</span>JobHandle inputDeps<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> <span class="token keyword">void</span> <span class="token function">OnCreateManager</span><span class="token punctuation">(</span><span class="token keyword">int</span> capacity<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        barrier <span class="token operator">=</span> World<span class="token punctuation">.</span><span class="token generic-method function">GetOrCreateManager<span class="token punctuation">&lt;</span>TBarrier<span class="token punctuation">></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">group</span> <span class="token operator">=</span> <span class="token function">GetComponentGroup</span><span class="token punctuation">(</span>ComponentType<span class="token punctuation">.</span><span class="token function">ReadOnly</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>TComponent<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> JobHandle <span class="token function">OnUpdate</span><span class="token punctuation">(</span>JobHandle inputDeps<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> jobHandle <span class="token operator">=</span> <span class="token function">CreateJobHandle</span><span class="token punctuation">(</span>inputDeps<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> removeJob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RemoveComponentJob</span>
        <span class="token punctuation">{</span>
            entities <span class="token operator">=</span> <span class="token keyword">group</span><span class="token punctuation">.</span><span class="token function">GetEntityArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            entityCommandBuffer <span class="token operator">=</span> barrier<span class="token punctuation">.</span><span class="token function">CreateCommandBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> removeJobHandle <span class="token operator">=</span> removeJob<span class="token punctuation">.</span><span class="token function">Schedule</span><span class="token punctuation">(</span>jobHandle<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> removeJobHandle<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>And now we can reuse this to create single-fire systems.</p><pre class="language-csharp"><code class="language-csharp"><span class="token punctuation">[</span><span class="token function">UpdateAfter</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>MoveForward2DSystem<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TransitionSystem</span> <span class="token punctuation">:</span> SingleFireSystem<span class="token operator">&lt;</span>Transition<span class="token punctuation">,</span> EndFrameBarrier<span class="token operator">></span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span>ComputeJobOptimization<span class="token punctuation">]</span>
    <span class="token keyword">struct</span> CopyTransition <span class="token punctuation">:</span> IJobProcessComponentData<span class="token operator">&lt;</span>Transition<span class="token punctuation">,</span> Position2D<span class="token operator">></span>
    <span class="token punctuation">{</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Execute</span><span class="token punctuation">(</span>
            <span class="token punctuation">[</span>ReadOnly<span class="token punctuation">]</span><span class="token keyword">ref</span> Transition transition<span class="token punctuation">,</span> 
            <span class="token keyword">ref</span> Position2D position<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">></span> 
            position <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Position2D</span> <span class="token punctuation">{</span> Value <span class="token operator">=</span> transition<span class="token punctuation">.</span>Location <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">override</span> JobHandle <span class="token function">CreateJobHandle</span><span class="token punctuation">(</span>JobHandle inputDeps<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> job <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CopyTransition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> job<span class="token punctuation">.</span><span class="token function">Schedule</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> inputDeps<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>Now we’ve got a reusable system for handling tasks when we need something that only works for one update. A useful system for triggers, or collisions, etc.</p></div></div><div class="row"><div class="col-lg-8 col-md-10 mx-auto"><hr><h3>comment:</h3><div id="gitment-container"></div><link rel="stylesheet" href="https://aimingoo.github.io/gitmint/style/default.css"><script src="https://aimingoo.github.io/gitmint/dist/gitmint.browser.js"></script><script type="text/javascript">var gitment=new Gitmint({id:window.location.pathname,owner:"60yaks",admin:["distantcam"],repo:"60yaks.github.io",oauth:{client_secret:"a0aaa27833a70b7120064204c58461286427d38b",client_id:"5198e17218b77c4ca3d7"}});gitment.render("gitment-container");</script></div></div></div></article><hr><!-- Footer --><footer><div class="container"><div class="row"><div class="col-lg-8 col-md-10 mx-auto"><ul class="list-inline text-center"><li class="list-inline-item"><a target="_blank" href="https://twitter.com/60yaks"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-twitter fa-stack-1x fa-inverse"></i></span></a></li><li class="list-inline-item"><a target="_blank" href="https://github.com/60yaks"><span class="fa-stack fa-lg"><i class="fa fa-circle fa-stack-2x"></i> <i class="fa fa-github fa-stack-1x fa-inverse"></i></span></a></li></ul><p class="copyright text-muted">Copyright &copy; 60 Yaks 2018</p></div></div></div></footer><!-- Bootstrap core JavaScript --><script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.bundle.min.js" integrity="sha384-u/bQvRA/1bobcXlcEYpsEdFVK/vJs3+T+nXLsBYJthmdBuavHvAW6UsmqO2Gd/F9" crossorigin="anonymous"></script><!-- Custom scripts for this template --><script src="/js/theme.js"></script><script>!function(o){var i=Array.prototype.slice.call(document.querySelectorAll("img[data-original]"));function c(t,e){var n=new Image,o=t.getAttribute("data-original");n.onload=function(){t.src=o,e&&e()},n.src=o}function n(){for(var t=0;t<i.length;t++)e=i[t],void 0,0<=(n=e.getBoundingClientRect()).top&&0<=n.left&&n.top<=(o.innerHeight||document.documentElement.clientHeight)&&c(i[t],function(){i.splice(t,t)});var e,n;console.log("trigger")}n(),o.addEventListener("scroll",function(){var t,e;t=n,e=o,clearTimeout(t.tId),t.tId=setTimeout(function(){t.call(e)},500)})}(this);</script></body></html>